---
title: Testing Patterns
description: Test your VeloxTS application effectively.
---

Testing patterns for VeloxTS applications.

## Unit Testing Procedures

```typescript
import { setupTestContext } from '@veloxts/core';
import { userProcedures } from '@/procedures/users';

describe('userProcedures', () => {
  test('createUser creates a user', async () => {
    const ctx = await setupTestContext();

    const result = await userProcedures.procedures.createUser.handler({
      input: { name: 'Alice', email: 'alice@example.com' },
      ctx,
    });

    expect(result.name).toBe('Alice');
  });
});
```

## Integration Testing

```typescript
import { veloxApp } from '@veloxts/velox';

describe('API Integration', () => {
  let app: ReturnType<typeof velox>;

  beforeAll(async () => {
    app = veloxApp();
    app.procedures(userProcedures);
    await app.ready();
  });

  afterAll(() => app.close());

  test('GET /api/users returns users', async () => {
    const response = await app.inject({
      method: 'GET',
      url: '/api/users',
    });

    expect(response.statusCode).toBe(200);
    expect(JSON.parse(response.body)).toBeInstanceOf(Array);
  });
});
```

## Mocking

```typescript
import { vi } from 'vitest';

vi.mock('@/database', () => ({
  db: {
    user: {
      findMany: vi.fn().mockResolvedValue([]),
      create: vi.fn().mockImplementation((data) => ({
        id: '1',
        ...data.data,
      })),
    },
  },
}));
```

## Type Testing

```typescript
import { expectTypeOf } from 'vitest';
import type { User } from '@/schemas/user';

test('User type has correct shape', () => {
  expectTypeOf<User>().toHaveProperty('id');
  expectTypeOf<User>().toHaveProperty('email');
});
```

## Auth Testing Utilities

The `@veloxts/auth/testing` subpath provides utilities for test isolation:

```typescript
import {
  _resetGuardCounter,
  clearRateLimitStore,
  clearAuthRateLimitStore,
  clearPolicies,
  stopAuthRateLimitCleanup,
} from '@veloxts/auth/testing';

beforeEach(() => {
  // Reset guard counter for deterministic guard naming
  _resetGuardCounter();

  // Clear rate limit stores between tests
  clearRateLimitStore();
  clearAuthRateLimitStore();

  // Clear registered policies
  clearPolicies();
});

afterAll(() => {
  // Stop background cleanup timers
  stopAuthRateLimitCleanup();
});
```

### Available Utilities

| Utility | Purpose |
|---------|---------|
| `_resetGuardCounter()` | Reset auto-generated guard names for deterministic tests |
| `clearRateLimitStore()` | Clear the middleware rate limit store |
| `clearAuthRateLimitStore()` | Clear the auth-specific rate limit store |
| `clearPolicies()` | Clear all registered authorization policies |
| `stopAuthRateLimitCleanup()` | Stop background cleanup intervals |

These utilities are internal and prefixed with underscore to indicate they're not part of the stable public API. Import from `@veloxts/auth/testing` rather than the main `@veloxts/auth` entry point.

## Next Steps

- [Database Testing](/docs/database/testing/) - DB patterns
- [Procedures](/docs/router/procedures/) - Procedure API
