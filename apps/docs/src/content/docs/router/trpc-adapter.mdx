---
title: tRPC Adapter
description: Configure tRPC for type-safe internal APIs.
---

import { Aside, Tabs, TabItem } from '@astrojs/starlight/components';

VeloxTS uses tRPC under the hood for type-safe procedure calls. This page covers tRPC-specific configuration.

## Quick Start

Use the `rpc()` helper to create a typed tRPC router:

```typescript
// src/router.ts
import { rpc } from '@veloxts/velox';
import { userProcedures } from './procedures/users';
import { postProcedures } from './procedures/posts';

// IMPORTANT: Use `as const` for full type inference
export const collections = [userProcedures, postProcedures] as const;

// Create typed tRPC router
const { router } = rpc(collections, { prefix: '/trpc' });

export { router };
export type AppRouter = typeof router;
```

Register with your app:

```typescript
// src/index.ts
import { veloxApp, registerRpc, rest } from '@veloxts/velox';
import { collections } from './router.js';

const app = await veloxApp({ port: 3030 });

// Register tRPC at /trpc
await registerRpc(app, collections, { prefix: '/trpc' });

// Optionally register REST at /api
app.routes(rest([...collections], { prefix: '/api' }));

await app.start();
```

## API Reference

### `rpc(collections, options)`

Creates a typed tRPC router from procedure collections.

```typescript
import { rpc } from '@veloxts/velox';

const { router, register } = rpc(collections, {
  prefix: '/trpc',  // Endpoint prefix (default: '/trpc')
});

// router: Fully typed tRPC router for type export
// register: Async function to register with Fastify
```

<Aside type="caution">
Always use `as const` on the collections array to preserve literal types:

```typescript
// ✅ Good - full type inference
export const collections = [userProcedures, postProcedures] as const;

// ❌ Bad - loses specific types
export const collections = [userProcedures, postProcedures];
```
</Aside>

### `registerRpc(app, collections, options)`

Convenience function that combines router creation and registration:

```typescript
import { registerRpc } from '@veloxts/velox';

// One-liner registration
const router = await registerRpc(app, collections, { prefix: '/trpc' });
export type AppRouter = typeof router;
```

### `serve(app, collections, options)`

Unified function for both REST and tRPC:

```typescript
import { serve } from '@veloxts/velox';

// Both REST and tRPC
const router = await serve(app, collections, {
  api: '/api',    // REST prefix (false to disable)
  rpc: '/trpc',   // tRPC prefix (false to disable)
});

// tRPC only
const router = await serve(app, collections, { api: false });

// REST only
await serve(app, collections, { rpc: false });
```

## Client Setup

<Tabs>
  <TabItem label="VeloxTS Client (Recommended)">
```typescript
// lib/api.ts
import { createClient } from '@veloxts/client';
import type { AppRouter } from '../../api/src/router.js';

// Works with tRPC router types from rpc()
export const api = createClient<AppRouter>({
  baseUrl: 'http://localhost:3030/trpc',
  // mode: 'trpc' - auto-detected when baseUrl ends with /trpc
});

// Fully typed!
const users = await api.users.listUsers();
const user = await api.users.getUser({ id: '123' });
await api.users.createUser({ name: 'Alice', email: 'alice@example.com' });
```
  </TabItem>
  <TabItem label="React Query Hooks">
```typescript
// lib/api.ts
import { createVeloxHooks } from '@veloxts/client/react';
import type { AppRouter } from '../../api/src/router.js';

// Works with tRPC router types from rpc()
export const api = createVeloxHooks<AppRouter>();

// In component
function UserList() {
  const { data } = api.users.listUsers.useQuery();
  return <ul>{data?.data.map(u => <li key={u.id}>{u.name}</li>)}</ul>;
}

function UserProfile({ userId }: { userId: string }) {
  // Suspense variant
  const { data: user } = api.users.getUser.useSuspenseQuery({ id: userId });
  return <h1>{user.name}</h1>;
}
```
  </TabItem>
  <TabItem label="Raw tRPC Client">
```typescript
import { createTRPCClient, httpBatchLink } from '@trpc/client';
import type { AppRouter } from '../server/router';

export const trpc = createTRPCClient<AppRouter>({
  links: [
    httpBatchLink({
      url: 'http://localhost:3030/trpc',
    }),
  ],
});

// Fully typed!
const users = await trpc.users.listUsers.query();
const user = await trpc.users.getUser.query({ id: '123' });
await trpc.users.createUser.mutate({ name: 'Alice', email: 'alice@example.com' });
```
  </TabItem>
</Tabs>

## Type Inference

Types flow automatically from backend to frontend:

```typescript
// Backend defines the shape
const createUser = procedure()
  .input(z.object({
    name: z.string(),
    email: z.string().email(),
  }))
  .mutation(...)

// Frontend gets the types
trpc.users.createUser.mutate({
  name: 'Alice',  // TypeScript knows this is required
  email: 'alice@example.com',
  // @ts-error - 'age' doesn't exist
  age: 30,
});
```

<Aside type="tip">
The type inference requires:
1. Using `as const` on collections
2. Exporting `type AppRouter = typeof router` where `router` comes from `rpc()`
</Aside>

## Batching

tRPC automatically batches multiple queries:

```typescript
// These are batched into a single HTTP request
const [users, posts] = await Promise.all([
  trpc.users.listUsers.query(),
  trpc.posts.listPosts.query(),
]);
```

## Error Handling

tRPC errors are automatically formatted:

```typescript
try {
  await trpc.users.getUser.query({ id: 'invalid' });
} catch (error) {
  if (error.data?.code === 'NOT_FOUND') {
    // Handle not found
  }
}
```

## tRPC vs REST

| Feature | tRPC | REST |
|---------|------|------|
| Type safety | Full inference | Manual typing |
| Batching | Automatic | Manual |
| Caching | React Query | HTTP cache |
| External clients | TypeScript only | Any language |
| OpenAPI docs | No | Yes |

<Aside type="tip">
Use tRPC for internal TypeScript clients (React, React Native). Use REST for external APIs, mobile apps in other languages, or third-party integrations. VeloxTS generates both from the same procedures.
</Aside>

## Related Content

- [Client Package](/docs/rsc/client-package/) - VeloxTS client
- [REST Conventions](/docs/router/rest-conventions/) - REST endpoints
- [Procedures](/docs/router/procedures/) - Define procedures
