# VeloxTS Project - Cursor AI Rules

This is a VeloxTS full-stack TypeScript application.

## Project Type

- **Framework**: VeloxTS (Laravel-inspired TypeScript framework)
/* @if rsc */
- **Architecture**: React Server Components with Vinxi
- **Backend**: Fastify embedded in Vinxi (/api/* routes)
- **Frontend**: React 19 + RSC + file-based routing
/* @endif rsc */
/* @if !rsc */
- **Backend**: Fastify + VeloxTS procedures (apps/api)
- **Frontend**: React + Vite + TanStack Router (apps/web)
/* @endif !rsc */
- **Database**: Prisma with SQLite
- **Validation**: Zod schemas

## Architecture Rules

/* @if rsc */
### RSC Architecture (Single App)

This project uses React Server Components with a unified structure:

```
app/
├── pages/           # File-based routing (RSC pages)
│   ├── index.tsx    # / (home)
│   ├── users.tsx    # /users
│   └── [id].tsx     # Dynamic routes
├── layouts/         # Layout components
│   └── root.tsx     # Root layout
└── actions/         # Server actions
    └── users.ts     # User actions with validated()

src/
├── api/             # API layer
│   ├── handler.ts   # Fastify API handler
│   ├── procedures/  # Procedure definitions
│   └── schemas/     # Zod schemas
└── entry.server.tsx # Server entry
```

### Server Actions

Use `validated()` for secure server actions:

```typescript
// app/actions/users.ts
'use server';
import { validated, validatedMutation, validatedQuery } from '@veloxts/web/server';
import { z } from 'zod';

// Public query
export const searchUsers = validatedQuery(
  z.object({ query: z.string().optional() }),
  async (input) => {
    return db.user.findMany({ where: { name: { contains: input.query } } });
  }
);

// Protected mutation
export const updateUser = validatedMutation(
  z.object({ id: z.string(), name: z.string() }),
  async (input, ctx) => {
    return db.user.update({ where: { id: input.id }, data: input });
  }
);
```

### File-Based Routing

- `app/pages/index.tsx` → `/`
- `app/pages/users.tsx` → `/users`
- `app/pages/users/[id].tsx` → `/users/:id` (dynamic)
- `app/pages/[...slug].tsx` → catch-all route
- `app/pages/(group)/page.tsx` → route groups (no URL segment)
/* @endif rsc */

/* @if !rsc */
### Backend (apps/api)

Procedures in `src/procedures/` define API endpoints. Naming conventions determine HTTP methods:

- `get*`, `find*` → GET (single resource)
- `list*` → GET (collection)
- `create*`, `add*` → POST
- `update*`, `edit*` → PUT
- `patch*` → PATCH
- `delete*`, `remove*` → DELETE

Schemas in `src/schemas/` use Zod for validation.

### Frontend (apps/web)

Routes in `src/routes/` use TanStack Router file-based routing.
API calls use `@veloxts/client` hooks: `useQuery`, `useMutation`.
Types flow from backend automatically - no codegen needed.
/* @endif !rsc */

### Context Object

Available in all procedures via `ctx`:

- `ctx.db` - Prisma client
- `ctx.request` - Fastify request
- `ctx.reply` - Fastify reply
/* @if auth */
- `ctx.user` - Authenticated user (if logged in)
/* @endif auth */

## Code Style

### TypeScript Strictness

CRITICAL - Never violate these rules:
- NEVER use `any` type
- NEVER use `as any` assertions
- NEVER use `@ts-ignore` or `@ts-expect-error`
- Use `unknown` with type guards instead
- Use proper generics and type inference

### Procedure Pattern

```typescript
import { procedure, procedures, z } from '@veloxts/velox';

export const entityProcedures = procedures('entities', {
  getEntity: procedure()
    .input(z.object({ id: z.string().uuid() }))
    .output(EntitySchema)
    .query(async ({ input, ctx }) => {
      return ctx.db.entity.findUnique({ where: { id: input.id } });
    }),

  createEntity: procedure()
    .input(CreateEntitySchema)
    .output(EntitySchema)
    .mutation(async ({ input, ctx }) => {
      return ctx.db.entity.create({ data: input });
    }),
});
```

### Schema Pattern

```typescript
import { z } from '@veloxts/velox';

export const EntitySchema = z.object({
  id: z.string().uuid(),
  name: z.string().min(1).max(255),
  createdAt: z.date(),
});

export type Entity = z.infer<typeof EntitySchema>;

export const CreateEntitySchema = EntitySchema.omit({
  id: true,
  createdAt: true,
});

export type CreateEntity = z.infer<typeof CreateEntitySchema>;
```

/* @if auth */
### Protected Procedures

```typescript
import { authenticated, hasRole } from '@veloxts/auth';

// Require authentication
const getProfile = procedure()
  .guard(authenticated)
  .query(({ ctx }) => ctx.user);

// Require role
const adminOnly = procedure()
  .guard(hasRole('admin'))
  .mutation(({ ctx, input }) => { /* ... */ });
```
/* @endif auth */

## CLI Commands

Common commands for development:

```bash
# Development
__RUN_CMD__ dev                      # Start dev server with HMR
__RUN_CMD__ velox dev --verbose      # With timing info

# Code generation
__RUN_CMD__ velox make resource Post --crud  # Full CRUD resource
__RUN_CMD__ velox make procedure Users       # Just procedure
__RUN_CMD__ velox make schema Post           # Just schema

# Database
__RUN_CMD__ velox migrate run        # Run migrations
__RUN_CMD__ velox migrate status     # Check status
__RUN_CMD__ velox db seed            # Run seeders
__RUN_CMD__ db:push                  # Push schema (Prisma)
__RUN_CMD__ db:studio                # Open Prisma Studio
```

## File Naming Conventions

/* @if rsc */
- Pages: `app/pages/{path}.tsx` (kebab-case)
- Layouts: `app/layouts/{name}.tsx`
- Actions: `app/actions/{entity}.ts`
- Procedures: `src/api/procedures/{entity}.ts`
- Schemas: `src/api/schemas/{entity}.ts`
/* @endif rsc */
/* @if !rsc */
- Procedures: `apps/api/src/procedures/{entity}.ts` (plural, kebab-case)
- Schemas: `apps/api/src/schemas/{entity}.ts` (singular, kebab-case)
- Routes: `apps/web/src/routes/{path}.tsx`
- Components: `apps/web/src/components/{Name}.tsx` (PascalCase)
/* @endif !rsc */

## Import Conventions

```typescript
// VeloxTS imports (use umbrella package)
import { procedure, procedures, z } from '@veloxts/velox';
/* @if auth */
import { authenticated, hasRole } from '@veloxts/auth';
/* @endif auth */

// Database client from config
/* @if rsc */
import { db } from '@/api/database';
/* @endif rsc */
/* @if !rsc */
import { db } from '../config/database';
/* @endif !rsc */

// Local schemas
import { UserSchema, CreateUserSchema } from '../schemas/user';
```

## Error Handling

Use structured errors with codes:

```typescript
import { VeloxError } from '@veloxts/core';

// Not found
throw VeloxError.notFound('User', userId);

// Validation
throw VeloxError.validation('Invalid email format');

// Unauthorized
throw VeloxError.unauthorized('Login required');

// Forbidden
throw VeloxError.forbidden('Cannot access this resource');
```

## AI-Powered Development

### MCP Integration

VeloxTS includes an MCP server for AI assistants:

```bash
# Start MCP server
npx @veloxts/mcp

# With debug logging
npx @veloxts/mcp --debug
```

### JSON Output for AI

All CLI commands support `--json` for AI tooling:

```bash
velox migrate status --json
velox make resource Post --json --dry-run
velox procedures list --json
velox introspect --json
```

### Introspection

```bash
# Full project introspection
velox introspect all --json

# List all procedures
velox procedures list --json

# List all routes
velox routes list
```
